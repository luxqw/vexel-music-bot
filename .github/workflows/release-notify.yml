name: Release Notify

on:
  release:
    types: [published]

jobs:
  notify:
    runs-on: ubuntu-latest
    if: startsWith(github.event.release.tag_name, 'dev-v')

    steps:
      - name: Send Discord Release Notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_DEV || secrets.DISCORD_WEBHOOK }}
        run: |
          RELEASE_NAME="${{ github.event.release.name }}"
          TAG_NAME="${{ github.event.release.tag_name }}"
          AUTHOR_LOGIN="${{ github.event.release.author.login }}"
          RELEASE_URL="${{ github.event.release.html_url }}"
          REPO_OWNER="${{ github.repository_owner }}"

          JSON_PAYLOAD=$(jq -n \
            --arg title "New Dev Release Published!" \
            --arg description "**Release Name:** $RELEASE_NAME\n**Tag:** `$TAG_NAME`\n**Author:** $AUTHOR_LOGIN\n**URL:** [View Release]($RELEASE_URL)" \
            --arg url "$RELEASE_URL" \
            --arg color 16776960 \
            --arg thumbnail "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" \
            --arg footer "Dev Environment ‚Ä¢ Release" \
            --arg icon_url "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" \
            --arg timestamp "${{ github.event.release.published_at }}" \
            --arg docker_image "ghcr.io/$REPO_OWNER/vexel-music-bot:$TAG_NAME" \
            '{
              "embeds": [
                {
                  "title": $title,
                  "description": $description,
                  "url": $url,
                  "color": ($color | tonumber),
                  "thumbnail": { "url": $thumbnail },
                  "footer": { "text": $footer, "icon_url": $icon_url },
                  "timestamp": $timestamp,
                  "fields": [
                    {
                      "name": "üê≥ Docker Image",
                      "value": "```\n" + $docker_image + "```",
                      "inline": false
                    }
                  ]
                }
              ]
            }')

          curl -H "Content-Type: application/json" \
               -d "$JSON_PAYLOAD" \
               $DISCORD_WEBHOOK_URL
