name: Production Release

on:
  release:
    types: [published]

jobs:
  build:
    runs-on: ubuntu-latest
    if: "!startsWith(github.event.release.tag_name, 'dev-v')"
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}
          
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/vexel-music-bot:${{ github.event.release.tag_name }}
          
      - name: Notify Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_PROD || secrets.DISCORD_WEBHOOK }}
        run: |
          RELEASE_NAME="${{ github.event.release.name }}"
          TAG_NAME="${{ github.event.release.tag_name }}"
          RELEASE_URL="${{ github.event.release.html_url }}"
          REPO_OWNER="${{ github.repository_owner }}"
          
          JSON_PAYLOAD=$(jq -n \
            --arg title "üöÄ New Production Release!" \
            --arg color 3066993 \
            --arg description "**Release Name:** $RELEASE_NAME\n**Tag:** `$TAG_NAME`\n**URL:** [View Release]($RELEASE_URL)" \
            --arg url "$RELEASE_URL" \
            --arg footer "Production ‚Ä¢ GitHub Actions" \
            --arg icon_url "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" \
            --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)" \
            --arg docker_image "ghcr.io/$REPO_OWNER/vexel-music-bot:$TAG_NAME" \
            '{
              "embeds": [
                {
                  "title": $title,
                  "description": $description,
                  "url": $url,
                  "color": ($color | tonumber),
                  "footer": { "text": $footer, "icon_url": $icon_url },
                  "timestamp": $timestamp,
                  "fields": [
                    {
                      "name": "üê≥ Docker Image",
                      "value": "```\n" + $docker_image + "```",
                      "inline": false
                    }
                  ]
                }
              ]
            }')
          
          curl -H "Content-Type: application/json" \
               -d "$JSON_PAYLOAD" \
               $DISCORD_WEBHOOK_URL
