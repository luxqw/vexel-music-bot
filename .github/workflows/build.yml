name: Docker Image Build & Push

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Docker image tag (e.g., v1.1.0)'
        required: false
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Build and push Docker image
        id: build_push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: >
            ghcr.io/${{ github.repository_owner }}/vexel-music-bot:${{ github.event.release.tag_name || github.event.inputs.tag || github.sha }}
            ghcr.io/${{ github.repository_owner }}/vexel-music-bot:latest

      - name: Notify Discord
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_DEV || secrets.DISCORD_WEBHOOK }}
        run: |
          if [[ "${{ job.status }}" == "success" ]]; then
            STATUS_MSG="‚úÖ Build Completed Successfully!"
            COLOR=3066993
          else
            STATUS_MSG="‚ùå Build Failed!"
            COLOR=16711680
          fi
          
          TAG_NAME="${{ github.event.release.tag_name || github.event.inputs.tag || 'undefined' }}"
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -n1 | sed 's/"/\\"/g')
          
          JSON_PAYLOAD=$(jq -n \
            --arg title "$STATUS_MSG" \
            --arg color "$COLOR" \
            --arg description "**Tag:** `$TAG_NAME`\n**Commit:** [\`$SHORT_SHA\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})\n**Message:** $COMMIT_MSG" \
            --arg url "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --arg footer "GitHub Actions" \
            --arg icon_url "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" \
            --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)" \
            --arg new_tag "$TAG_NAME" \
            --arg repo_owner "${{ github.repository_owner }}" \
            '{
              "embeds": [
                {
                  "title": $title,
                  "description": $description,
                  "url": $url,
                  "color": ($color | tonumber),
                  "footer": { "text": $footer, "icon_url": $icon_url },
                  "timestamp": $timestamp,
                  "fields": [
                    {
                      "name": "üê≥ Docker Images",
                      "value": "```\nghcr.io/" + $repo_owner + "/vexel-music-bot:" + $new_tag + "\nghcr.io/" + $repo_owner + "/vexel-music-bot:latest\n```",
                      "inline": false
                    }
                  ]
                }
              ]
            }')
          
          curl -H "Content-Type: application/json" \
               -d "$JSON_PAYLOAD" \
               $DISCORD_WEBHOOK_URL
